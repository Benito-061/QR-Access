<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> QR Access </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0ea5e9;
            --secondary: #06b6d4;
            --accent: #14b8a6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #fffaf0;
            --border: #cbd5e1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 40%, #0ea5e9 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(-10px);
            }
            50% {
                transform: translateY(10px);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes alarm {
            0%, 100% { transform: scale(1); background-color: var(--danger); }
            50% { transform: scale(1.05); background-color: #ff6b6b; }
        }

        /* Container principal */
        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            animation: float 3s ease-in-out infinite;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 12px 24px;
            border: 2px solid transparent;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--dark);
        }

        .nav-tab:hover {
            background: var(--light);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        /* Alerte et notifications */
        .alarm-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(239, 68, 68, 0.4);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out, shake 0.5s ease-in-out infinite;
        }

        .alarm-notification.active {
            display: block;
        }

        .alarm-notification.alarm-active {
            animation: alarm 0.5s ease-in-out infinite;
        }

        .alarm-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alarm-icon {
            font-size: 24px;
            animation: pulse 1s ease-in-out infinite;
        }

        .alarm-text {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .alarm-title {
            font-weight: 700;
            font-size: 16px;
        }

        .alarm-details {
            font-size: 12px;
            opacity: 0.9;
        }

        .alarm-close {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .alarm-close:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Contenu rincioal */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            animation: slideInRight 0.6s ease-out;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: rgba(255, 250, 240, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            animation: fadeIn 0.8s ease-out;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 2px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: var(--light);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buotons */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(236, 72, 153, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4);
        }

        .btn-small {
            padding: 10px 18px;
            font-size: 12px;
        }

        /* Conteneur du code QR */
        .qr-container {
            background: linear-gradient(135deg, var(--light) 0%, #f3f4f6 100%);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            border: 2px dashed var(--border);
            transition: all 0.3s ease;
        }

        .qr-container:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f0f7ff 0%, #f5f3ff 100%);
        }

        /* Couleurs pour section ceremonie */
        #ceremonie .card {
            background: linear-gradient(135deg, #fff0f6 0%, #fff7f9 100%);
            border: 1px solid rgba(236,72,153,0.08);
            box-shadow: 0 25px 60px rgba(236,72,153,0.06);
        }

        #ceremonie h2 {
            color: #e11d48;
        }

        #ceremonie .btn-primary {
            background: linear-gradient(135deg, #e11d48 0%, #fb7185 100%);
            box-shadow: 0 10px 30px rgba(225,29,72,0.12);
        }

        #qrContainerCer {
            background: linear-gradient(135deg, #fff5f8 0%, #fffafc 100%);
            border: 2px dashed rgba(236,72,153,0.2);
        }

        #qrCodeCer img, #qrCodeCer canvas {
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(225,29,72,0.10);
        }

        #qrCerQuickCode {
            color: #be123c;
        }

        #mariageFields {
            border-color: rgba(236,72,153,0.12);
            background: linear-gradient(135deg, #fff7fb 0%, #fff 100%);
        }

        #qrCode {
            animation: fadeIn 0.5s ease-out;
        }

        .qr-text {
            text-align: center;
            font-size: 12px;
            color: var(--dark);
            opacity: 0.7;
        }

        /* Section Camera */
        .camera-section {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px dashed var(--border);
            animation: fadeIn 0.5s ease-out;
        }

        .camera-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-section h3::before {
            content: 'üì∑';
        }

        #videoCapture {
            width: 100%;
            border-radius: 12px;
            background: #000;
            margin-bottom: 15px;
            display: none;
            max-height: 300px;
            object-fit: cover;
        }

        #photoPreview {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
            display: none;
            max-height: 300px;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .camera-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .camera-status {
            text-align: center;
            color: var(--dark);
            font-size: 14px;
            opacity: 0.7;
            margin-top: 10px;
        }

        /* List de visiteurs */
        .visitors-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .visitor-item {
            background: linear-gradient(135deg, var(--light) 0%, #f3f4f6 100%);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideInRight 0.5s ease-out;
            gap: 15px;
        }

        .visitor-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.1);
        }

        .visitor-item.expired {
            opacity: 0.6;
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
        }

        .visitor-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid var(--border);
        }

        .visitor-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .visitor-info {
            flex: 1;
        }

        .visitor-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .visitor-meta {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.7;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .visitor-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
        }

        .visitor-status.expiring {
            color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .visitor-status.expired {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .visitor-status.active {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Stats de grilles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: rgba(255, 250, 240, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            animation: fadeIn 0.8s ease-out;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-8px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.7;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Onglets */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* Modale */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }

        /* Remplacement en ligne `background: white` utilisations inserer via JS/modele */
        [style*="background: white"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background:white"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background: white;"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background:white;"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background:#fff"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background: #fff"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background:#ffffff"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background: #ffffff"] { background: var(--surface) !important; color: var(--dark) !important; }
        [style*="background: rgba(255, 255, 255"] { background: rgba(255, 250, 240, 0.95) !important; color: var(--dark) !important; }
        [style*="background:rgba(255,255,255"] { background: rgba(255, 250, 240, 0.95) !important; color: var(--dark) !important; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark);
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg);
            color: var(--primary);
        }

        /* Rapport journalier */
        .report-section {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--light) 0%, #f3f4f6 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .report-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .report-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .report-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.7;
            text-transform: uppercase;
            font-weight: 600;
        }

        .modal-content-large {
            max-width: 750px;
        }

        /* Journal d'acces */
        .log-item {
            background: var(--light);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            font-size: 13px;
            animation: slideInRight 0.5s ease-out;
        }

        .log-item.denied {
            border-left-color: var(--danger);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
        }

        .log-timestamp {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .log-details {
            color: var(--dark);
            opacity: 0.7;
        }

        /* Bar de defilement */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Sensible */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-tabs {
                width: 100%;
                flex-wrap: wrap;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }

            .alarm-notification {
                left: 10px;
                right: 10px;
                bottom: auto;
            }

            .visitor-item {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!--Notifications de l'alarme -->
    <div class="alarm-notification" id="alarmNotification">
        <div class="alarm-content">
            <span class="alarm-icon">üö®</span>
            <div class="alarm-text">
                <div class="alarm-title">Invitation Expir√©e!</div>
                <div class="alarm-details" id="alarmDetails">Un rendez-vous a expir√©</div>
            </div>
            <button class="alarm-close" onclick="closeAlarm()">‚úï</button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">üé´</div>
                    QR Access Manager
                </div>
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('dashboard', this)">üìä Tableau de bord</button>
                    <button class="nav-tab" onclick="switchTab('create', this)">‚ûï Ajouter un rendez-vous</button>
                    <button class="nav-tab" onclick="switchTab('ceremonie', this)">üéâ Ajouter une c√©r√©monie</button>
                    <button class="nav-tab" onclick="switchTab('verify', this)">‚úì V√©rifier</button>
                    <button class="nav-tab" onclick="switchTab('history', this)">üìú Historique</button>
                </div>
            </div>
        </header>

        <!-- Tableau de bord -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-box">
                    <div class="stat-label">Rendez-vous Actifs</div>
                    <div class="stat-value" id="activeCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Cr√©√©s</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Expirations Proches</div>
                    <div class="stat-value" id="expiringCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Acc√®s Aujourd'hui</div>
                    <div class="stat-value" id="accessCount">0</div>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <h2>Rendez-vous Actifs</h2>
                    <div class="visitors-grid" id="visitorsActive"></div>
                </div>

                <div class="card">
                    <h2>Alertes et Expirations</h2>
                    <div class="visitors-grid" id="visitorsExpiring"></div>
                </div>
            </div>

            <div class="main-content" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="showDailyReport()" style="width: 100%; margin-bottom: 15px;">
                    üìä Voir le Bilan Journalier 
                </button>
                <button class="btn btn-danger" onclick="resetInvitations()" style="width: 100%;">
                    üîÑ R√©initialiser les Invitations
                </button>
            </div>
        </div>

        <!-- Creer un onglet -->
        <div id="create" class="tab-content">
            <div class="main-content">
                <div class="card">
                    <h2>Cr√©er une Invitations Temporaire</h2>
                    <form id="createForm" onsubmit="createVisitor(event)">
                        <div class="form-group">
                            <label for="visitorName">Nom Complet</label>
                            <input type="text" id="visitorName" required placeholder="Ex: Benito Uwase">
                        </div>

                        <div class="form-group">
                            <label for="visitorEmail">Email</label>
                            <input type="email" id="visitorEmail" placeholder="benito@example.com">
                        </div>

                        <div class="form-group">
                            <label for="visitorPhone">T√©l√©phone</label>
                            <input type="tel" id="visitorPhone" required placeholder="+243 991 048 061">
                        </div>

                        <div class="form-group">
                            <label for="visitorSex">Sexe</label>
                            <select id="visitorSex" required>
                                 <option value=""> -- S√©lectionner -- </option>
                                <option value="Masculin">Masculin</option>
                                <option value="F√©minin">F√©minin</option>
                            
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="visitorType">Type de Rendez-vous</label>
                            <select id="visitorType" required>
                                 <option value="">-- S√©lectionner --</option>
                                <option value="visiteur">Rendez-vous Entreprise</option>
                                <option value="Rendez-vous medical">Rendez-vous Medical</option>
                                <option value="participant">Participant √âv√©nement</option>
                                <option value="invite">Invit√©</option>
                                <option value="prestataire">Prestataire</option>
                                <option value="salle_de_sport">Salle de sport</option>
                                <option value="visiteur">Visiteur</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="visitorLocation">Lieu d'Acc√®s</label>
                            <input type="text" id="visitorLocation" required placeholder="Ex: B√¢timent A, √âtage 3">
                        </div>

                        <div class="form-group">
                            <label for="visitorService">Service</label>
                            <input type="text" id="visitorService" required placeholder="Ex: Ressources Humaines, IT, Accueil">
                        </div>

                        <div class="form-group">
                            <label for="startDateTime">Date & Heure de D√©but</label>
                            <input type="datetime-local" id="startDateTime" required>
                        </div>

                        <div class="form-group">
                            <label for="endDateTime">Date & Heure de Fin</label>
                            <input type="datetime-local" id="endDateTime" required>
                        </div>

                        <div class="form-group">
                            <label for="visitorNotes">Laisser un mot </label>
                            <textarea id="visitorNotes" placeholder="Informations suppl√©mentaires..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%;">üé´ G√©n√©rer Invitation et QR Code</button>
                    </form>

                    <!-- Section de la camera -->
                    <div class="camera-section">
                        <h3>Prendre une Photo du Visiteur</h3>
                        <video id="videoCapture" width="320" height="240" autoplay playsinline></video>
                        <img id="photoPreview" alt="Photo du visiteur">
                        <div class="camera-buttons">
                            <button type="button" class="btn btn-secondary btn-small" onclick="startCamera()" id="startCameraBtn">üì∑ D√©marrer Cam√©ra</button>
                            <button type="button" class="btn btn-ghost btn-small" onclick="switchVisitorCamera()" id="switchCamBtn" title="Changer cam√©ra">‚ÜîÔ∏è</button>
                            <button type="button" class="btn btn-success btn-small" onclick="capturePhoto()" id="capturePhotoBtn" style="display: none;">üì∏ Prendre Photo</button>
                            <button type="button" class="btn btn-secondary btn-small" onclick="stopCamera()" id="stopCameraBtn" style="display: none;">‚èπÔ∏è Arr√™ter Cam√©ra</button>
                            <button type="button" class="btn btn-danger btn-small" onclick="clearPhoto()" id="clearPhotoBtn" style="display: none;">üóëÔ∏è Effacer Photo</button>
                        </div>
                        <div class="camera-status" id="cameraStatus">Pr√™t √† capturer une photo</div>
                    </div>
                </div>

                <div class="card">
                    <h2>QR Code G√©n√©r√©</h2>
                    <div class="qr-container" id="qrContainer" style="display: none;">
                        <div id="qrCode"></div>
                            <p class="qr-text">Code unique pour: <strong id="qrVisitorName"></strong></p>
                            <p class="qr-text">Sexe: <strong id="qrVisitorSex"></strong></p>
                        <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                            <p style="margin: 0; font-size: 12px; opacity: 0.9;">Code Rapide (5 chiffres)</p>
                            <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px;">
                                <p style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: 4px; font-family: monospace;" id="qrQuickCode"></p>
                                <button id="copyQuickBtn" class="btn btn-ghost btn-small" onclick="copyQuickCode('qrQuickCode','copyQuickBtn')" title="Copier le code">üìã</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="downloadQR()">‚¨áÔ∏è T√©l√©charger</button>
                        <button class="btn btn-primary btn-small" onclick="printQR()">üñ®Ô∏è Imprimer</button>
                    </div>
                    <div style="text-align: center; color: var(--dark); opacity: 0.5; margin-top: 40px;">
                        Les codes QR appara√Ætront ici
                    </div>
                </div>
            </div>
        </div>

        <!-- C√©r√©monie -->
        <div id="ceremonie" class="tab-content">
            <div class="main-content">
                <div class="card">
                    <h2>C√©r√©monie</h2>
                    
                    <!-- Section Affichage des Mari√©s -->
                    <div id="marriageDisplaySection" style="display: none; margin: 30px 0; padding: 25px; background: linear-gradient(135deg, #ffd6e8 0%, #fff4e6 50%, #e8f5ff 100%); border-radius: 15px; overflow: hidden; position: relative;">
                        <style>
                            @keyframes heartBeat {
                                0%, 100% { transform: scale(1); }
                                25% { transform: scale(1.1); }
                                50% { transform: scale(1); }
                            }
                            
                            @keyframes floatUp {
                                0% { opacity: 1; transform: translateY(0px); }
                                100% { opacity: 0; transform: translateY(-60px); }
                            }
                            
                            @keyframes shine {
                                0% { transform: translateX(-100%); }
                                100% { transform: translateX(100%); }
                            }
                            
                            .marriage-container {
                                display: flex;
                                justify-content: space-around;
                                align-items: center;
                                gap: 30px;
                                position: relative;
                                z-index: 2;
                            }
                            
                            .family-box {
                                flex: 1;
                                text-align: center;
                                padding: 20px;
                                background: white;
                                border-radius: 12px;
                                box-shadow: 0 8px 20px rgba(0,0,0,0.1);
                                position: relative;
                                overflow: hidden;
                                animation: heartBeat 2s ease-in-out infinite;
                            }
                            
                            .family-box:first-child {
                                background: linear-gradient(135deg, #ffd6e8 0%, #ffb3d9 100%);
                            }
                            
                            .family-box:last-child {
                                background: linear-gradient(135deg, #b3e5fc 0%, #81d4fa 100%);
                            }
                            
                            .family-label {
                                font-size: 13px;
                                color: #666;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                                font-weight: 600;
                                margin-bottom: 10px;
                            }
                            
                            .family-name {
                                font-size: 28px;
                                font-weight: 700;
                                color: #1a1a1a;
                                word-break: break-word;
                            }
                            
                            .hearts-container {
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                pointer-events: none;
                            }
                            
                            .heart {
                                position: absolute;
                                font-size: 20px;
                                animation: floatUp 3s ease-in forwards;
                            }
                            
                            .separator {
                                font-size: 30px;
                                color: #ff69b4;
                                font-weight: bold;
                                animation: heartBeat 1.5s ease-in-out infinite;
                            }
                            
                            .confetti {
                                position: absolute;
                                width: 10px;
                                height: 10px;
                                pointer-events: none;
                            }
                        </style>
                        
                        <div class="hearts-container" id="heartsContainer"></div>
                        
                        <div class="marriage-container">
                            <div class="family-box">
                                <div class="family-label">üë∞ La Famille</div>
                                <div class="family-name" id="displayFamily1">-</div>
                            </div>
                            
                            <div class="separator">üíï</div>
                            
                            <div class="family-box">
                                <div class="family-label">ü§µ La Famille</div>
                                <div class="family-name" id="displayFamily2">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <form id="createCeremonyForm" onsubmit="createCeremony(event)">
                        <div class="form-group">
                            <label for="cerName">Nom</label>
                            <input type="text" id="cerName" required placeholder="Ex: Nom de">
                        </div>

                        <div class="form-group">
                            <label for="cerPhone">Num√©ro de T√©l√©phone</label>
                            <input type="tel" id="cerPhone" required placeholder="+243 991 048 061">
                        </div>

                        <div class="form-group">
                            <label for="cerSex">Sexe</label>
                            <select id="cerSex" required>
                                <option value="">-- S√©lectionner --</option>
                                <option value="Masculin">Masculin</option>
                                <option value="F√©minin">F√©minin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="cerHonorific">Titre Honorifique</label>
                            <select id="cerHonorific" required>
                                <option value="">-- S√©lectionner --</option>
                                <option value="Monsieur">Mr.</option>
                                <option value="Madame">Mme.</option>
                                <option value="Mademoiselle">Mlle.</option>
                                <option value="Professeur">Proff.</option>
                                <option value="Honorable">Hon.</option>
                                <option value="Mgr">Mgr.</option>
                                <option value="Ingenieur">Ingenieur.</option>
                                <option value="Docteur">Docteur.</option>
                            </select>

                             <div class="form-group">
                            <label for="cerPlace">Place Attitr√©e</label>
                            <input type="text" id="cerPlace" required placeholder="Ex: Place VIP, Place Or...">
                        </div>
                        <div class="form-group">
                            <label for="cerCapacity">Nombre de personnes par invitation</label>
                            <select id="cerCapacity" required>
                                <option value="1">1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        </div>

                        <div class="form-group">
                            <label for="cerType">Type de C√©r√©monie</label>
                            <select id="cerType" required>
                                <option value="">-- S√©lectionner --</option>
                                <option value="Mariage">Mariage</option>
                                <option value="Anniversaire">Anniversaire</option>
                                <option value="Dote">Dote</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="cerLieu">Lieu de la C√©r√©monie</label>
                            <input type="text" id="cerLieu" required placeholder="Ex: Salle des F√™tes, √âglise Saint-Pierre...">
                        </div>

                        <div class="form-group">
                            <label for="cerFamily1">La Famille</label>
                            <input type="text" id="cerFamily1" required placeholder="Nom de la premi√®re famille">
                        </div>

                        <div class="form-group" id="cerFamily2Group" style="display: none;">
                            <label for="cerFamily2">La Famille</label>
                            <input type="text" id="cerFamily2" required placeholder="Nom de la deuxi√®me famille">
                        </div>

                        <div class="form-group">
                            <label for="cerProgram">Programme de la C√©r√©monie</label>
                            <textarea id="cerProgram" required placeholder="D√©tail des activit√©s et horaires (ex: 09h00 - Arriv√©e des invit√©s, 09h30 - D√©but de la c√©r√©monie...)"></textarea>
                        </div>

                        <!-- Detail du mariage -->
                        <div id="mariageFields" style="display: none; border: 2px dashed #0ea5e9; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h3 style="color: #0ea5e9; margin-top: 0;">üìç D√©tails du Mariage</h3>
                            
                            <!-- Section Affichage des Mari√©s -->
                            <div id="brideGroomDisplay" style="margin: 25px 0; padding: 25px; background: linear-gradient(135deg, #fff5f7 0%, #fff9e6 50%, #f0f9ff 100%); border-radius: 15px; overflow: hidden; position: relative; margin-bottom: 25px;">
                                <div class="hearts-container" id="heartsContainerBrideGroom"></div>
                                
                                <div class="marriage-container">
                                    <div class="family-box" style="background: linear-gradient(135deg, #ffd6e8 0%, #ffb3d9 100%);">
                                        <div class="family-label">üë∞ La Mari√©e</div>
                                        <div class="family-name" id="displayBrideName">-</div>
                                    </div>
                                    
                                    <div class="separator">üíï</div>
                                    
                                    <div class="family-box" style="background: linear-gradient(135deg, #b3e5fc 0%, #81d4fa 100%);">
                                        <div class="family-label">ü§µ Le Mari√©</div>
                                        <div class="family-name" id="displayGroomName">-</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Champs pour les noms des mari√©s -->
                            <div class="form-group">
                                <label for="cerBrideName">Nom de la Mari√©e</label>
                                <input type="text" id="cerBrideName" placeholder="Ex: Marie Dupont">
                            </div>

                            <div class="form-group">
                                <label for="cerGroomName">Nom du Mari√©</label>
                                <input type="text" id="cerGroomName" placeholder="Ex: Jean Martin">
                            </div>
                            
                            <div class="form-group">
                                <label for="cerEglise">√âglise</label>
                                <input type="text" id="cerEglise" required placeholder="Ex: Cath√©drale Saint-Paul">
                            </div>

                            <div class="form-group">
                                <label for="cerEgliseAdresse">Adresse de l'√âglise</label>
                                <input type="text" id="cerEgliseAdresse" required placeholder="Ex: Boulevard du Roi, Kinshasa">
                            </div>

                            <div class="form-group">
                                <label for="cerCommune">Commune</label>
                                <input type="text" id="cerCommune" required placeholder="Ex: Commune de Kalamu">
                            </div>

                            <div class="form-group">
                                <label for="cerPhotographe">Prise de Vue (Photographe/Vid√©ographe)</label>
                                <input type="text" id="cerPhotographe" required placeholder="Ex: Studio La Vie, Contact: +243 991...">
                            </div>

                            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                            
                            <h4 style="color: #0ea5e9;">‚è∞ √âv√©nements Horodat√©s</h4>
                            <div id="evenementsList"></div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addMariageEvent()">‚ûï Ajouter un √âv√©nement</button>
                        </div>

                        <div class="form-group">
                            <label for="cerStart">Date & Heure de D√©but</label>
                            <input type="datetime-local" id="cerStart" required>
                        </div>

                       
                        <div class="form-group">
                            <label for="cerNotes">Laissez un mot...</label>
                            <textarea id="cerNotes" placeholder="Informations suppl√©mentaires..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%;">üé´ G√©n√©rer C√©r√©monie et QR Code</button>
                    </form>

                    <!-- Section de la capture pour la C√©r√©monie -->
                    <div class="camera-section">
                        <h3>Prendre une Photo pour la C√©r√©monie</h3>
                        <video id="videoCaptureCer" width="320" height="240" autoplay playsinline style="display:none;"></video>
                        <img id="photoPreviewCer" alt="Photo de la c√©r√©monie" style="display:none; max-width:100%; border-radius:8px;"/>
                        <div class="camera-buttons">
                            <button type="button" class="btn btn-secondary btn-small" onclick="startCameraCer()" id="startCameraBtnCer">üì∑ D√©marrer Cam√©ra</button>
                            <button type="button" class="btn btn-ghost btn-small" onclick="switchCeremonyCamera()" id="switchCamBtnCer" title="Changer cam√©ra">‚ÜîÔ∏è</button>
                            <button type="button" class="btn btn-success btn-small" onclick="capturePhotoCer()" id="capturePhotoBtnCer" style="display: none;">üì∏ Prendre Photo</button>
                            <button type="button" class="btn btn-secondary btn-small" onclick="stopCameraCer()" id="stopCameraBtnCer" style="display: none;">‚èπÔ∏è Arr√™ter Cam√©ra</button>
                            <button type="button" class="btn btn-danger btn-small" onclick="clearPhotoCer()" id="clearPhotoBtnCer" style="display: none;">üóëÔ∏è Effacer Photo</button>
                        </div>
                        <div class="camera-status" id="cameraStatusCer">Pr√™t √† capturer une photo pour la c√©r√©monie</div>
                    </div>

                </div>

                <div class="card">
                    <h2>QR Code G√©n√©r√©</h2>
                    <div class="qr-container" id="qrContainerCer" style="display: none;">
                        <div id="qrCodeCer"></div>
                        <p class="qr-text">Code unique pour: <strong id="qrCerName"></strong></p>
                        <p class="qr-text">Type: <strong id="qrCerType"></strong></p>
                        <p class="qr-text">Lieu: <strong id="qrCerLieu"></strong></p>
                        <p class="qr-text">Sexe: <strong id="qrCerSex"></strong></p>
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                            <p style="margin: 0; font-size: 12px; opacity: 0.9;">Code Rapide (5 chiffres)</p>
                            <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px;">
                                <p style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: 4px; font-family: monospace;" id="qrCerQuickCode"></p>
                                <button id="copyCerQuickBtn" class="btn btn-ghost btn-small" onclick="copyQuickCode('qrCerQuickCode','copyCerQuickBtn')" title="Copier le code">üìã</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="downloadQRCer()">‚¨áÔ∏è T√©l√©charger</button>
                        <button class="btn btn-primary btn-small" onclick="printQRCer()">üñ®Ô∏è Imprimer</button>
                    </div>
                    <div style="text-align: center; color: var(--dark); opacity: 0.5; margin-top: 40px;">
                        Les codes QR des c√©r√©monies appara√Ætront ici
                    </div>
                </div>
            </div>
        </div>

        <!-- Onlglet verifier -->
        <div id="verify" class="tab-content">
            <div class="main-content">
                <div class="card">
                    <h2>V√©rifier une Invitation</h2>
                    <div class="form-group">
                        <label for="verifyCode">Code de V√©rification (QR, Code 5 chiffres ou ID)</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="text" id="verifyCode" placeholder="Scannez le QR code, entrez le code de 5 chiffres ou l'ID">
                            <button id="pasteVerifyBtn" class="btn btn-ghost btn-small" onclick="pasteIntoVerify('verifyCode','pasteVerifyBtn', true)" title="Coller depuis le presse-papiers">üì•</button>
                            <button id="startScanBtn" class="btn btn-ghost btn-small" onclick="toggleVerifyScanner()" title="Scanner via cam√©ra">üì∑</button>
                        </div>
                    </div>
                    <button class="btn btn-success" style="width: 100%;" onclick="verifyCode()">‚úì V√©rifier</button>

                    <div id="verifyScanner" style="display:none; margin-top:15px;">
                        <video id="verifyVideo" autoplay playsinline style="width:100%; border-radius:8px; background:#000; max-height:320px;"></video>
                        <canvas id="verifyCanvas" style="display:none;"></canvas>
                        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                            <button class="btn btn-danger btn-small" onclick="stopVerifyCamera()">‚èπÔ∏è Arr√™ter</button>
                            <span id="verifyCameraStatus" style="color:var(--dark);opacity:.8;">Cam√©ra inactive</span>
                        </div>
                    </div>

                    <div id="verifyResult" style="margin-top: 25px; display: none;">
                        <div id="verifyContent"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>Lecture Scanner QR</h2>
                    <div style="text-align: center; padding: 40px; background: var(--light); border-radius: 15px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì±</div>
                        <p style="color: var(--dark); opacity: 0.7; margin-bottom: 10px;">
                            Utilisez un scanner QR pour automatiser la v√©rification
                        </p>
                        <p style="font-size: 12px; color: var(--dark); opacity: 0.5;">
                            Les codes seront v√©rifi√©s automatiquement
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet histoqique -->
        <div id="history" class="tab-content">
            <div class="card">
                <h2>Historique des Acc√®s</h2>
                <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center;">
                    <input id="historySearch" placeholder="Rechercher par nom, code, t√©l√©phone, email..." style="flex:1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px;">
                    <button id="historyClearBtn" class="btn btn-secondary btn-small">Effacer</button>
                </div>

                <div id="historyResults" style="margin-top: 12px;"></div>
                <div id="accessLog" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Password protection modal for Create tab -->
    <div id="createPasswordModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîê Acc√®s - Ajouter un Rendez-vous</h2>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <input id="createPasswordInput" type="password" placeholder="Mot de passe" style="padding:10px;border:1px solid var(--border);border-radius:8px;" />
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="closeCreatePasswordModal()">Annuler</button>
                    <button class="btn btn-primary" onclick="verifyCreatePassword()">Acc√©der</button>
                </div>
                <div id="createPasswordMessage" style="color:var(--danger);display:none;margin-top:6px;"></div>
            </div>
        </div>
    </div>

    <!-- Password protection modal for Ceremony tab -->
    <div id="ceremonyPasswordModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîê Acc√®s - Ajouter une C√©r√©monie</h2>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <input id="ceremonyPasswordInput" type="password" placeholder="Mot de passe" style="padding:10px;border:1px solid var(--border);border-radius:8px;" />
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="closeCeremonyPasswordModal()">Annuler</button>
                    <button class="btn btn-primary" onclick="verifyCeremonyPassword()">Acc√©der</button>
                </div>
                <div id="ceremonyPasswordMessage" style="color:var(--danger);display:none;margin-top:6px;"></div>
            </div>
        </div>
    </div>

    <!-- Monthly site lock modal -->
    <div id="monthlyLockModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîí Verrouillage Mensuel</h2>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <p id="monthlyLockInfo">Le site est verrouill√© pour le d√©but du mois. Entrez le mot de passe pour d√©bloquer.</p>
                <input id="monthlyLockInput" type="password" placeholder=" Veillez entrez le mot de passe " style="padding:10px;border:1px solid var(--border);border-radius:8px;" />
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="closeMonthlyLockModal()">Annuler</button>
                    <button class="btn btn-primary" onclick="verifyMonthlyLock()">D√©bloquer</button>
                </div>
                <div id="monthlyLockMessage" style="color:var(--danger);display:none;margin-top:6px;"></div>
            </div>
        </div>
    </div>

    <!-- Rapport journalier -->
    <div id="reportModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2 class="modal-title">üìä Bilan Journalier</h2>
                <button class="modal-close" onclick="closeReportModal()">‚úï</button>
            </div>
            <div id="reportContent" style="max-height: 70vh; overflow-y: auto;"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeReportModal()">Fermer</button>
                <button class="btn btn-primary" onclick="downloadReport()">üì• T√©l√©charger Rapport</button>
            </div>
        </div>
    </div>

    <!-- Reinitialiser les invitations -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ö†Ô∏è R√©initialiser les Invitations</h2>
                <button class="modal-close" onclick="closeResetModal()">‚úï</button>
            </div>
            <p style="margin-bottom: 20px; color: var(--dark); line-height: 1.6;">
                Cette action supprimera toutes les invitations et r√©initialisera le syst√®me. Cette action est <strong>irr√©versible</strong>.
            </p>
            <p style="margin-bottom: 30px; color: var(--warning); background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                √ätes-vous certain de vouloir continuer?
            </p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeResetModal()">Annuler</button>
                <button class="btn btn-danger" onclick="confirmResetInvitations()">R√©initialiser</button>
            </div>
        </div>
    </div>

    <script>
        // Stockage de donn√©es 
        let visitors = JSON.parse(localStorage.getItem('visitors')) || [];
        let accessLog = JSON.parse(localStorage.getItem('accessLog')) || [];
        let currentQRCode = null;
        let currentPhotoCanvas = null;
        let currentPhotoCanvasCer = null;
        let streamActive = false;
        let visitorFacing = 'user';
        let ceremonyFacing = 'user';
        let visitorStreamActive = false;
        let ceremonyStreamActive = false;

        // Initialiser
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            setDateTime();
            startAlarmSystem();
            
            // Verif auto des entrees
            document.getElementById('verifyCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifyCode();
                }
            });

            // Detection auto de l'entree du scan
            let lastInputTime = 0;
            let inputCount = 0;
            document.getElementById('verifyCode').addEventListener('input', function(e) {
                const now = Date.now();
                const timeDiff = now - lastInputTime;
                
                if (timeDiff < 50) {
                    inputCount++;
                } else {
                    inputCount = 1;
                }
                
                lastInputTime = now;
                
                // Si la saisi ressemble a un code-barres (verif les saisis consecutive)
                if (this.value.length > 5 && inputCount > 3 && timeDiff < 50) {
                    setTimeout(() => verifyCode(), 100);
                }
            });
        });

        // Definir la date et l'heure actuelle comme valeur par defaut
        function setDateTime() {
            const now = new Date();
            const startInput = document.getElementById('startDateTime');
            const endInput = document.getElementById('endDateTime');
            const cerStartInput = document.getElementById('cerStart');
            const cerEndInput = document.getElementById('cerEnd');
            
            if (startInput) startInput.value = now.toISOString().slice(0, 16);
            if (endInput) {
                const later = new Date(now.getTime() + 2 * 60 * 60000);
                endInput.value = later.toISOString().slice(0, 16);
            }
            
            if (cerStartInput) cerStartInput.value = now.toISOString().slice(0, 16);
            if (cerEndInput) {
                const later = new Date(now.getTime() + 4 * 60 * 60000);
                cerEndInput.value = later.toISOString().slice(0, 16);
            }
        }

        // Onglet de changement
        const CREATE_PASSWORD = 'Benito2003';
        const CEREMONY_PASSWORD = 'Benito061';
        const MONTHLY_PASSWORD = 'Benito2003-Benito061';

        // Syst√®me de d√©tection d'appareil
        function getDeviceFingerprint() {
            return btoa(navigator.userAgent + navigator.language + screen.width + 'x' + screen.height);
        }

        function validateDeviceAccess() {
            const currentDevice = getDeviceFingerprint();
            const storedDevice = localStorage.getItem('deviceFingerprint');

            if (storedDevice !== currentDevice) {
                // Nouvel appareil d√©tect√© - r√©initialiser l'acc√®s
                localStorage.setItem('deviceFingerprint', currentDevice);
                localStorage.removeItem('createTabUnlocked');
                localStorage.removeItem('ceremonyTabUnlocked');
                console.log('Nouvel appareil d√©tect√© - codes d\'acc√®s r√©initialis√©s');
                return false;
            }
            return true;
        }

        // Verrouillage mensuel
        function getMonthKey() {
            const d = new Date();
            return d.getFullYear() + '-' + (d.getMonth() + 1);
        }

        function isMonthlyUnlocked() {
            return localStorage.getItem('monthlyUnlocked') === getMonthKey();
        }

        function showMonthlyModal() {
            const m = document.getElementById('monthlyLockModal');
            if (m) m.style.display = 'flex';
        }

        function verifyMonthlyLock() {
            const pwd = document.getElementById('monthlyLockInput').value;
            const msg = document.getElementById('monthlyLockMessage');
            if (pwd === MONTHLY_PASSWORD) {
                // Mark month as unlocked
                localStorage.setItem('monthlyUnlocked', getMonthKey());
                monthlyLocked = false;

                // IMPORTANT: do NOT unlock per-tab access when monthly unlock is entered.
                // Ensure create/ceremony tabs remain locked and clear any stored per-tab unlock flags.
                localStorage.removeItem('createTabUnlocked');
                localStorage.removeItem('ceremonyTabUnlocked');
                createTabUnlocked = false;
                ceremonyTabUnlocked = false;

                document.getElementById('monthlyLockModal').style.display = 'none';
                document.getElementById('monthlyLockInput').value = '';
                if (msg) msg.style.display = 'none';
            } else {
                if (msg) {
                    msg.style.display = 'block';
                    msg.textContent = 'Mot de passe incorrect';
                }
            }
        }

        function closeMonthlyLockModal() {
            const m = document.getElementById('monthlyLockModal');
            if (m) m.style.display = 'none';
            const input = document.getElementById('monthlyLockInput');
            if (input) input.value = '';
            const msg = document.getElementById('monthlyLockMessage');
            if (msg) msg.style.display = 'none';
        }

        // Valider l'appareil au chargement
        validateDeviceAccess();

        // Forcer le verrouillage mensuel au d√©but du mois si besoin
        let monthlyLocked = !isMonthlyUnlocked();
        if (monthlyLocked) {
            // Remove per-tab unlocks when site is monthly-locked
            localStorage.removeItem('createTabUnlocked');
            localStorage.removeItem('ceremonyTabUnlocked');
            // Show modal once DOM is ready
            document.addEventListener('DOMContentLoaded', showMonthlyModal);
        }

        let createTabUnlocked = localStorage.getItem('createTabUnlocked') === 'true';
        let ceremonyTabUnlocked = localStorage.getItem('ceremonyTabUnlocked') === 'true';

        function switchTab(tabName, buttonElement) {
            // Monthly site lock check
            if (monthlyLocked) {
                const m = document.getElementById('monthlyLockModal');
                if (m) m.style.display = 'flex';
                return;
            }

            // Check password protection for create and ceremonie tabs
            if (tabName === 'create' && !createTabUnlocked) {
                document.getElementById('createPasswordModal').style.display = 'flex';
                return;
            }
            if (tabName === 'ceremonie' && !ceremonyTabUnlocked) {
                document.getElementById('ceremonyPasswordModal').style.display = 'flex';
                return;
            }

            // Supp class active de tous les onglets et boutons
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Ajouter class active a l'onglet selectionne
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Ajouter class active au bouton selectionne
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Actualiser les donnees si on retourne au dashboard ou a l'historique
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'history') updateAccessLog();
        }

        // Password modal functions
        function verifyCreatePassword() {
            const pwd = document.getElementById('createPasswordInput').value;
            const msg = document.getElementById('createPasswordMessage');
            if (pwd === CREATE_PASSWORD) {
                createTabUnlocked = true;
                localStorage.setItem('createTabUnlocked', 'true');
                document.getElementById('createPasswordModal').style.display = 'none';
                document.getElementById('createPasswordInput').value = '';
                // Switch to create tab
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('create').classList.add('active');
                const btn = document.querySelector('[onclick*="switchTab(\'create\'"]');
                if (btn) btn.classList.add('active');
            } else {
                msg.style.display = 'block';
                msg.textContent = 'Mot de passe incorrect';
            }
        }

        function closeCreatePasswordModal() {
            document.getElementById('createPasswordModal').style.display = 'none';
            document.getElementById('createPasswordInput').value = '';
            document.getElementById('createPasswordMessage').style.display = 'none';
        }

        function verifyCeremonyPassword() {
            const pwd = document.getElementById('ceremonyPasswordInput').value;
            const msg = document.getElementById('ceremonyPasswordMessage');
            if (pwd === CEREMONY_PASSWORD) {
                ceremonyTabUnlocked = true;
                localStorage.setItem('ceremonyTabUnlocked', 'true');
                document.getElementById('ceremonyPasswordModal').style.display = 'none';
                document.getElementById('ceremonyPasswordInput').value = '';
                // Switch to ceremonie tab
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('ceremonie').classList.add('active');
                const btn = document.querySelector('[onclick*="switchTab(\'ceremonie\'"]');
                if (btn) btn.classList.add('active');
            } else {
                msg.style.display = 'block';
                msg.textContent = 'Mot de passe incorrect';
            }
        }

        function closeCeremonyPasswordModal() {
            document.getElementById('ceremonyPasswordModal').style.display = 'none';
            document.getElementById('ceremonyPasswordInput').value = '';
            document.getElementById('ceremonyPasswordMessage').style.display = 'none';
        }

        // Fonction de la camera pour la capture de photo du visiteur
        function startCamera() {
            const video = document.getElementById('videoCapture');
            const startBtn = document.getElementById('startCameraBtn');
            const captureBtn = document.getElementById('capturePhotoBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const statusDiv = document.getElementById('cameraStatus');
            const constraints = { video: { facingMode: visitorFacing }, audio: false };
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    visitorStreamActive = true;
                    startBtn.style.display = 'none';
                    captureBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'inline-block';
                    statusDiv.textContent = 'Cam√©ra active - Cliquez sur "Prendre Photo"';
                    statusDiv.style.color = '#10b981';
                })
                .catch(function(error) {
                    statusDiv.textContent = '‚ùå Erreur: Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions.';
                    statusDiv.style.color = '#ef4444';
                    console.error('Erreur cam√©ra:', error);
                });
        }

        function capturePhoto() {
            const video = document.getElementById('videoCapture');
            const preview = document.getElementById('photoPreview');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            currentPhotoCanvas = canvas;
            preview.src = canvas.toDataURL('image/jpeg', 0.9);
            preview.style.display = 'block';

            document.getElementById('capturePhotoBtn').style.display = 'none';
            document.getElementById('stopCameraBtn').style.display = 'none';
            document.getElementById('clearPhotoBtn').style.display = 'inline-block';
            document.getElementById('startCameraBtn').style.display = 'inline-block';

            stopCamera();
            document.getElementById('cameraStatus').textContent = '‚úì Photo captur√©e avec succ√®s!';
            document.getElementById('cameraStatus').style.color = '#10b981';
        }

        function stopCamera() {
            const video = document.getElementById('videoCapture');
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
                visitorStreamActive = false;
            }

            if (!document.getElementById('photoPreview').src || !document.getElementById('photoPreview').src.includes('data:')) {
                document.getElementById('startCameraBtn').style.display = 'inline-block';
                document.getElementById('capturePhotoBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
            }
        }

        function clearPhoto() {
            const preview = document.getElementById('photoPreview');
            preview.src = '';
            preview.style.display = 'none';
            currentPhotoCanvas = null;

            document.getElementById('startCameraBtn').style.display = 'inline-block';
            document.getElementById('clearPhotoBtn').style.display = 'none';
            document.getElementById('cameraStatus').textContent = 'Photo supprim√©e - Cliquez sur "D√©marrer Cam√©ra"';
            document.getElementById('cameraStatus').style.color = '#6b7280';
        }

                // Camera pour la c√©r√©monie
                function startCameraCer() {
                    const video = document.getElementById('videoCaptureCer');
                    const startBtn = document.getElementById('startCameraBtnCer');
                    const captureBtn = document.getElementById('capturePhotoBtnCer');
                    const stopBtn = document.getElementById('stopCameraBtnCer');
                    const statusDiv = document.getElementById('cameraStatusCer');
                    const constraints = { video: { facingMode: ceremonyFacing }, audio: false };
                    navigator.mediaDevices.getUserMedia(constraints)
                        .then(function(stream) {
                            video.srcObject = stream;
                            video.style.display = 'block';
                            ceremonyStreamActive = true;
                            startBtn.style.display = 'none';
                            captureBtn.style.display = 'inline-block';
                            stopBtn.style.display = 'inline-block';
                            statusDiv.textContent = 'Cam√©ra active - Cliquez sur "Prendre Photo"';
                            statusDiv.style.color = '#10b981';
                        })
                        .catch(function(error) {
                            statusDiv.textContent = '‚ùå Erreur: Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions.';
                            statusDiv.style.color = '#ef4444';
                            console.error('Erreur cam√©ra (ceremonie):', error);
                        });
                }

                function capturePhotoCer() {
                    const video = document.getElementById('videoCaptureCer');
                    const preview = document.getElementById('photoPreviewCer');
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    canvas.width = video.videoWidth || 320;
                    canvas.height = video.videoHeight || 240;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    currentPhotoCanvasCer = canvas;
                    preview.src = canvas.toDataURL('image/jpeg', 0.9);
                    preview.style.display = 'block';

                    document.getElementById('capturePhotoBtnCer').style.display = 'none';
                    document.getElementById('stopCameraBtnCer').style.display = 'none';
                    document.getElementById('clearPhotoBtnCer').style.display = 'inline-block';
                    document.getElementById('startCameraBtnCer').style.display = 'inline-block';

                    stopCameraCer();
                    document.getElementById('cameraStatusCer').textContent = '‚úì Photo captur√©e avec succ√®s!';
                    document.getElementById('cameraStatusCer').style.color = '#10b981';
                }

                function stopCameraCer() {
                    const video = document.getElementById('videoCaptureCer');
                    if (video && video.srcObject) {
                        const tracks = video.srcObject.getTracks();
                        tracks.forEach(track => track.stop());
                        video.srcObject = null;
                        video.style.display = 'none';
                        ceremonyStreamActive = false;
                    }

                    if (!document.getElementById('photoPreviewCer').src || !document.getElementById('photoPreviewCer').src.includes('data:')) {
                        document.getElementById('startCameraBtnCer').style.display = 'inline-block';
                        document.getElementById('capturePhotoBtnCer').style.display = 'none';
                        document.getElementById('stopCameraBtnCer').style.display = 'none';
                    }
                }

                function clearPhotoCer() {
                    const preview = document.getElementById('photoPreviewCer');
                    preview.src = '';
                    preview.style.display = 'none';
                    currentPhotoCanvasCer = null;

                    document.getElementById('startCameraBtnCer').style.display = 'inline-block';
                    document.getElementById('clearPhotoBtnCer').style.display = 'none';
                    document.getElementById('cameraStatusCer').textContent = 'Photo supprim√©e - Cliquez sur "D√©marrer Cam√©ra"';
                    document.getElementById('cameraStatusCer').style.color = '#6b7280';
                }

        // Cree un visiteur
        function createVisitor(e) {
            e.preventDefault();

            if (typeof monthlyLocked !== 'undefined' && monthlyLocked) {
                showMonthlyModal();
                return;
            }

            // Generer un code de 5 chiffres
            const quickCode = String(Math.floor(10000 + Math.random() * 90000));

            const visitor = {
                id: 'VIS-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                quickCode: quickCode,
                name: document.getElementById('visitorName').value,
                sexe: document.getElementById('visitorSex').value,
                email: document.getElementById('visitorEmail').value,
                phone: document.getElementById('visitorPhone').value,
                type: document.getElementById('visitorType').value,
                location: document.getElementById('visitorLocation').value,
                service: document.getElementById('visitorService').value,
                startTime: new Date(document.getElementById('startDateTime').value),
                endTime: new Date(document.getElementById('endDateTime').value),
                notes: document.getElementById('visitorNotes').value,
                createdAt: new Date(),
                scans: [],
                photo: currentPhotoCanvas ? currentPhotoCanvas.toDataURL('image/jpeg', 0.9) : null,
                category: 'visitor'
            };

            visitors.push(visitor);
            localStorage.setItem('visitors', JSON.stringify(visitors));

            console.log('createCeremony: saving visitor and generating QR', visitor);
            generateQRCode(visitor);
            document.getElementById('createForm').reset();
            clearPhoto();
            setDateTime();
            updateDashboard();

            alert('‚úì Invitation cr√©√©e avec succ√®s!');
        }

        // Basculer cam√©ra visiteur (user <-> environment)
        function switchVisitorCamera() {
            visitorFacing = (visitorFacing === 'user') ? 'environment' : 'user';
            const btn = document.getElementById('switchCamBtn');
            if (btn) btn.textContent = (visitorFacing === 'user') ? '‚ÜîÔ∏è' : '‚ÜîÔ∏è';
            if (visitorStreamActive) {
                stopCamera();
                setTimeout(() => startCamera(), 250);
            }
        }

        // Basculer cam√©ra c√©r√©monie (user <-> environment)
        function switchCeremonyCamera() {
            ceremonyFacing = (ceremonyFacing === 'user') ? 'environment' : 'user';
            const btn = document.getElementById('switchCamBtnCer');
            if (btn) btn.textContent = (ceremonyFacing === 'user') ? '‚ÜîÔ∏è' : '‚ÜîÔ∏è';
            if (ceremonyStreamActive) {
                stopCameraCer();
                setTimeout(() => startCameraCer(), 250);
            }
        }

        // Cree une Ceremonie
        function createCeremony(e) {
            e.preventDefault();
            if (typeof monthlyLocked !== 'undefined' && monthlyLocked) {
                showMonthlyModal();
                return;
            }
            console.log('createCeremony called');

            const quickCode = String(Math.floor(10000 + Math.random() * 90000));
            const cerType = document.getElementById('cerType').value;
            console.log('Ceremony type:', cerType);
            
            // Detrminer les familles associees a la ceremonie 
            let families = [];
            const family1 = document.getElementById('cerFamily1').value;
            if (cerType === 'Mariage' || cerType === 'Dote') {
                const family2 = document.getElementById('cerFamily2').value;
                families = [family1, family2];
            } else {
                families = [family1];
            }

            // Securite pour les dates de la ceremonie 
            const cerStartVal = document.getElementById('cerStart')?.value;
            const cerEndEl = document.getElementById('cerEnd');
            const cerStart = cerStartVal ? new Date(cerStartVal) : new Date();
            const cerEnd = (cerEndEl && cerEndEl.value) ? new Date(cerEndEl.value) : new Date(cerStart.getTime() + 4 * 60 * 60000);

            const visitor = {
                id: 'CER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                quickCode: quickCode,
                name: document.getElementById('cerName').value,
                email: '',
                phone: document.getElementById('cerPhone').value,
                sexe: document.getElementById('cerSex').value,
                honorific: document.getElementById('cerHonorific').value,
                type: cerType,
                location: document.getElementById('cerLieu').value,
                place: document.getElementById('cerPlace')?.value || '',
                families: families,
                program: document.getElementById('cerProgram').value,
                requestNumber: '',
                service: '',
                startTime: cerStart,
                endTime: cerEnd,
                notes: document.getElementById('cerNotes').value,
                createdAt: new Date(),
                scans: [],
                photo: currentPhotoCanvasCer ? currentPhotoCanvasCer.toDataURL('image/jpeg', 0.9) : null,
                capacity: (document.getElementById('cerCapacity') ? parseInt(document.getElementById('cerCapacity').value) : 1),
                category: 'ceremonie'
            };

            // Ajouter les details specifiques au mariage si le type de ceremonie est "Mariage"
            if (cerType === 'Mariage') {
                visitor.mariage = {
                    eglise: document.getElementById('cerEglise')?.value || '',
                    egliseAdresse: document.getElementById('cerEgliseAdresse')?.value || '',
                    commune: document.getElementById('cerCommune')?.value || '',
                    photographe: document.getElementById('cerPhotographe')?.value || '',
                    evenements: mariageEvents
                };
                // Reinitaliser les evenements du mariage pour la prochaine ceremonie
                mariageEvents = [];
                document.getElementById('evenementsList').innerHTML = '';
            }

            visitors.push(visitor);
            localStorage.setItem('visitors', JSON.stringify(visitors));

            generateQRCode(visitor);

            document.getElementById('createCeremonyForm').reset();
            setDateTime();
            updateDashboard();

            alert('‚úì C√©r√©monie cr√©√©e avec succ√®s!');
        }

        // Basculer l'affichage des champs de famille en fonction du type de c√©r√©monie
        document.addEventListener('DOMContentLoaded', function() {
            const cerTypeSelect = document.getElementById('cerType');
            const family2Group = document.getElementById('cerFamily2Group');
            const mariageFields = document.getElementById('mariageFields');
            const marriageDisplaySection = document.getElementById('marriageDisplaySection');
            const family1Input = document.getElementById('cerFamily1');
            const family2Input = document.getElementById('cerFamily2');
            const displayFamily1 = document.getElementById('displayFamily1');
            const displayFamily2 = document.getElementById('displayFamily2');
            const brideNameInput = document.getElementById('cerBrideName');
            const groomNameInput = document.getElementById('cerGroomName');
            const displayBrideName = document.getElementById('displayBrideName');
            const displayGroomName = document.getElementById('displayGroomName');
            
            if (cerTypeSelect) {
                cerTypeSelect.addEventListener('change', function() {
                    const type = this.value;
                    family2Group.style.display = (type === 'Mariage' || type === 'Dote') ? 'block' : 'none';
                    mariageFields.style.display = (type === 'Mariage') ? 'block' : 'none';
                    marriageDisplaySection.style.display = (type === 'Mariage') ? 'block' : 'none';
                    const family2Input = document.getElementById('cerFamily2');
                    if (type === 'Mariage' || type === 'Dote') {
                        family2Input.required = true;
                    } else {
                        family2Input.required = false;
                    }
                    if (type === 'Mariage') {
                        generateHearts();
                        generateHeartsBrideGroom();
                    }
                });
            }
            
            // Met √† jour les noms des familles en temps r√©el
            if (family1Input) {
                family1Input.addEventListener('input', function() {
                    if (displayFamily1) displayFamily1.textContent = this.value || '-';
                });
            }
            
            if (family2Input) {
                family2Input.addEventListener('input', function() {
                    if (displayFamily2) displayFamily2.textContent = this.value || '-';
                });
            }
            
            // Met √† jour les noms des mari√©s en temps r√©el
            if (brideNameInput) {
                brideNameInput.addEventListener('input', function() {
                    if (displayBrideName) displayBrideName.textContent = this.value || '-';
                });
            }
            
            if (groomNameInput) {
                groomNameInput.addEventListener('input', function() {
                    if (displayGroomName) displayGroomName.textContent = this.value || '-';
                });
            }
        });
        
        // G√©n√©rateur de c≈ìurs anim√©s
        function generateHearts() {
            const container = document.getElementById('heartsContainer');
            if (!container) return;
            container.innerHTML = ''; // Nettoyage des anciens c≈ìurs
            
            const hearts = ['üíï', 'üíñ', 'üíó', 'üíù', '‚ú®', 'üéâ'];
            for (let i = 0; i < 12; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.top = '-20px';
                heart.style.animationDelay = Math.random() * 0.5 + 's';
                heart.style.fontSize = (Math.random() * 15 + 15) + 'px';
                container.appendChild(heart);
            }
        }
        
        // G√©n√©rateur de c≈ìurs anim√©s pour la section des mari√©s
        function generateHeartsBrideGroom() {
            const container = document.getElementById('heartsContainerBrideGroom');
            if (!container) return;
            container.innerHTML = ''; // Nettoyage des anciens c≈ìurs
            
            const hearts = ['üíï', 'üíñ', 'üíó', 'üíù', '‚ú®', 'üéâ'];
            for (let i = 0; i < 12; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.top = '-20px';
                heart.style.animationDelay = Math.random() * 0.5 + 's';
                heart.style.fontSize = (Math.random() * 15 + 15) + 'px';
                container.appendChild(heart);
            }
        }

        // Tableau pour stocker les evenements horodates du mariage
        let mariageEvents = [];

        // Fonctions pour gerer les evenements du mariage
        function addMariageEvent() {
            const eventId = 'event-' + Date.now();
            const event = {
                id: eventId,
                time: '',
                description: ''
            };
            mariageEvents.push(event);
            renderMariageEvents();
        }

        // Fonctions pour supprimer un evenement du mariage
        function removeMariageEvent(eventId) {
            mariageEvents = mariageEvents.filter(e => e.id !== eventId);
            renderMariageEvents();
        }

        // Fonctions pour mettre a jour l'heure d'un evenement du mariage
        function updateEventTime(eventId, time) {
            const event = mariageEvents.find(e => e.id === eventId);
            if (event) event.time = time;
        }

        // Fonctions pour mettre a jour la description d'un evenement du mariage
        function updateEventDescription(eventId, description) {
            const event = mariageEvents.find(e => e.id === eventId);
            if (event) event.description = description;
        }

        // Fonctions pour render les evenements du mariage dans le formulaire
        function renderMariageEvents() {
            const container = document.getElementById('evenementsList');
            container.innerHTML = '';
            
            mariageEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.style.cssText = 'background: #f0fdf4; border: 1px solid #d1fae5; border-radius: 8px; padding: 15px; margin: 10px 0; display: flex; gap: 10px; align-items: flex-start;';
                
                eventDiv.innerHTML = `
                    <div style="flex: 1;">
                        <input type="time" value="${event.time}" onchange="updateEventTime('${event.id}', this.value)" 
                               style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-weight: 600; color: #065f46;">
                        <input type="text" value="${event.description}" placeholder="Ex: √âchange des alliances" 
                               onchange="updateEventDescription('${event.id}', this.value)"
                               style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #cbd5e1; border-radius: 6px; color: #065f46;">
                    </div>
                    <button type="button" onclick="removeMariageEvent('${event.id}')" class="btn btn-danger btn-small" style="white-space: nowrap;">üóëÔ∏è Supprimer</button>
                `;
                container.appendChild(eventDiv);
            });
        }

        // Generer le QR Code pour un visiteur ou une ceremonie
        function generateQRCode(visitor) {
            console.log('generateQRCode called for:', visitor.name, 'category:', visitor.category);
            const isCer = visitor && visitor.category === 'ceremonie';
            console.log('isCer:', isCer);
            const qrCodeId = isCer ? 'qrCodeCer' : 'qrCode';
            const qrContainerId = isCer ? 'qrContainerCer' : 'qrContainer';
            const nameId = isCer ? 'qrCerName' : 'qrVisitorName';
            const sexId = isCer ? 'qrCerSex' : 'qrVisitorSex';
            const quickId = isCer ? 'qrCerQuickCode' : 'qrQuickCode';

            const qrContainer = document.getElementById(qrCodeId);
            if (!qrContainer) return;

            qrContainer.innerHTML = '';
            currentQRCode = visitor;

            try {
                if (typeof QRCode === 'undefined') {
                    throw new Error('QRCode library not loaded');
                }
                const qr = new QRCode(qrContainer, {
                    text: visitor.id,
                    width: 256,
                    height: 256,
                    colorDark: "#0f172a",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                const nameEl = document.getElementById(nameId);
                if (nameEl) nameEl.textContent = visitor.name;
                const sexEl = document.getElementById(sexId);
                if (sexEl) sexEl.textContent = visitor.sexe || 'N/A';
                const quickEl = document.getElementById(quickId);
                if (quickEl) quickEl.textContent = visitor.quickCode;

                if (isCer) {
                    const typeEl = document.getElementById('qrCerType');
                    const lieuEl = document.getElementById('qrCerLieu');
                    if (typeEl) typeEl.textContent = visitor.type || '';
                    if (lieuEl) lieuEl.textContent = visitor.location || '';
                }

                document.getElementById(qrContainerId).style.display = 'flex';

                console.log('QR Code generated successfully for:', visitor.name);
            } catch (error) {
                console.error('Error generating QR code:', error);
                const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(visitor.id)}`;
                qrContainer.innerHTML = `<img src="${apiUrl}" alt="QR Code" style="width: 256px; height: 256px; border-radius: 8px;">`;

                const nameEl = document.getElementById(nameId);
                if (nameEl) nameEl.textContent = visitor.name;
                const sexEl2 = document.getElementById(sexId);
                if (sexEl2) sexEl2.textContent = visitor.sexe || 'N/A';
                const quickEl = document.getElementById(quickId);
                if (quickEl) quickEl.textContent = visitor.quickCode;

                if (isCer) {
                    const typeEl = document.getElementById('qrCerType');
                    const lieuEl = document.getElementById('qrCerLieu');
                    if (typeEl) typeEl.textContent = visitor.type || '';
                    if (lieuEl) lieuEl.textContent = visitor.location || '';
                }

                document.getElementById(qrContainerId).style.display = 'flex';

                console.log('QR Code generated via API for:', visitor.name);
            }
        }

        // Telecharger le QR Code
        function downloadQR() {
            if (!currentQRCode) return;

            const selector = (currentQRCode && currentQRCode.category === 'ceremonie') ? '#qrCodeCer' : '#qrCode';
            const container = document.querySelector(selector);
            if (!container) {
                alert('Pas de QR Code √† t√©l√©charger');
                return;
            }

            const canvas = container.querySelector('canvas');
            const img = container.querySelector('img');
            let dataUrl;

            if (canvas) {
                dataUrl = canvas.toDataURL();
            } else if (img) {
                // Pour les QR codes g√©n√©r√©s via l'API, on peut directement utiliser l'URL de l'image pour le t√©l√©chargement
                const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=${encodeURIComponent(currentQRCode.id)}`;
                const link = document.createElement('a');
                link.href = apiUrl;
                link.download = `QR_${currentQRCode.name}_${Date.now()}.png`;
                link.click();
                return;
            } else {
                alert('Pas de QR Code √† t√©l√©charger');
                return;
            }

            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `QR_${currentQRCode.name}_${Date.now()}.png`;
            link.click();
        }

        // Imprimer le QR Code
        function printQR() {
            if (!currentQRCode) return;
            const isCer = currentQRCode && currentQRCode.category === 'ceremonie';
            const qrSelector = isCer ? '#qrCodeCer' : '#qrCode';
            const container = document.querySelector(qrSelector);
            if (!container) return;

            const canvas = container.querySelector('canvas');
            const img = container.querySelector('img');
            let dataUrl;

            if (canvas) dataUrl = canvas.toDataURL();
            else if (img) dataUrl = img.src;
            if (!dataUrl) return;

            const printWindow = window.open('', '_blank');
            const title = `QR Code - ${currentQRCode.name || ''}`;
            printWindow.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title></head><body style="display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;padding:30px;">`);
            printWindow.document.write(`<h2 style="margin-bottom:10px;">${title}</h2>`);
            printWindow.document.write(`<img src="${dataUrl}" style="width:320px;height:320px;border-radius:8px;"/>`);
            // Preferer le code rapide du QR actuel, sinon celui affiche dans le QR code, sinon celui du visiteur/ceremonie
            const quickEl = isCer ? document.getElementById('qrCerQuickCode') : document.getElementById('qrQuickCode');
            const quickCode = (quickEl && quickEl.textContent && quickEl.textContent.trim()) || (currentQRCode && currentQRCode.quickCode) || '';
            if (quickCode) {
                printWindow.document.write(`<div style="margin-top:12px;font-size:18px;color:#0f172a;">Code rapide:</div>`);
                printWindow.document.write(`<div style="margin-top:6px;font-size:28px;font-weight:800;letter-spacing:8px;color:#0f172a;">${quickCode}</div>`);
            }
            printWindow.document.write(`<div style="margin-top:18px;font-size:14px;">Nom: ${currentQRCode.name || ''}</div>`);
            printWindow.document.write(`<div style="font-size:13px;">T√©l√©phone: ${currentQRCode.phone || 'Non fourni'}</div>`);
            printWindow.document.write(`<div style="font-size:13px;">Type: ${currentQRCode.type || ''}</div>`);
            printWindow.document.write(`</body></html>`);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 300);
        }

        function downloadQRCer() { downloadQR(); }
        function printQRCer() { printQR(); }

        // Copier le code rapide dans le presse-papiers avec fallback
        function copyQuickCode(quickId, btnId) {
            const el = document.getElementById(quickId);
            if (!el) return;
            const code = el.textContent.trim();
            if (!code) return;

            const setFeedback = (btn, text) => {
                if (!btn) return;
                const old = btn.textContent;
                btn.textContent = text;
                setTimeout(() => btn.textContent = old, 1500);
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    setFeedback(document.getElementById(btnId), 'Copi√©!');
                }).catch(() => fallbackCopy(code, btnId));
            } else {
                fallbackCopy(code, btnId);
            }
        }

        function fallbackCopy(text, btnId) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); setTimeout(() => {}, 0); } catch (e) {}
            document.body.removeChild(ta);
            const btn = document.getElementById(btnId);
            if (btn) { const old = btn.textContent; btn.textContent = 'Copi√©!'; setTimeout(()=> btn.textContent = old, 1500); }
        }

        // Coller le code rapide depuis le presse-papiers avec fallback
        async function pasteIntoVerify(inputId, btnId, autoVerify = false) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(btnId);
            if (!input) return;

            const setFeedback = (b, text) => {
                if (!b) return;
                const old = b.textContent;
                b.textContent = text;
                setTimeout(() => b.textContent = old, 1500);
            };

            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    const txt = await navigator.clipboard.readText();
                    if (txt && txt.trim().length) {
                        input.value = txt.trim();
                        setFeedback(btn, 'Coll√©!');
                        input.focus();
                        if (autoVerify) verifyCode();
                        return;
                    }
                }
            } catch (e) {
                // Ignorer les erreurs de lecture du presse-papiers et passer au fallback
            }

            // Chuten de secours pour les navigateurs sans support du presse-papiers ou en cas d'erreur
            const manual = prompt('Collez le code ici puis validez:');
            if (manual !== null) {
                const v = manual.trim();
                if (v.length) {
                    input.value = v;
                    setFeedback(btn, 'Coll√©!');
                    input.focus();
                    if (autoVerify) verifyCode();
                }
            }
        }

        // Generer l'affichage de la verification pour une ceremonie
        function generateVerificationDisplay(visitor, isValid, timeRemaining, isExpired, isComing, photoDisplay) {
            const isCer = visitor.category === 'ceremonie';
            
            if (isValid && isCer) {
                const familiesDisplay = visitor.families && visitor.families.length > 0 
                    ? visitor.families.join(' & ')
                    : 'N/A';
                
                return `
                    <div style="background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%); border: 3px solid #10b981; border-radius: 12px; padding: 25px; animation: slideInRight 0.3s ease-out;">
                        <div style="font-size: 64px; margin-bottom: 15px; text-align: center;">‚úì</div>
                        <div style="font-weight: 700; color: #10b981; margin-bottom: 20px; text-align: center; font-size: 20px;">Acc√®s Autoris√©</div>
                        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);">
                            <div style="display: grid; gap: 12px;">
                                <div style="text-align:center;">${photoDisplay}</div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Nom de la C√©r√©monie</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #065f46; margin-top: 5px;">${visitor.name}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Type de C√©r√©monie</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üéâ ${visitor.type}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Famille(s)</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üë• ${familiesDisplay}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Lieu</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üìç ${visitor.location}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Place Attitr√©e</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üìå ${visitor.place || 'N/A'}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Nombre de personnes</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üë• ${visitor.capacity || 1}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Programme</div>
                                    <div style="font-size: 13px; color: #065f46; margin-top: 3px; white-space: pre-wrap;">${visitor.program || 'N/A'}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Sexe</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">‚öß ${visitor.sexe || 'N/A'}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">T√©l√©phone</div>
                                    <div style="font-size: 13px; color: #065f46; margin-top: 3px;">üì± ${visitor.phone || 'N/A'}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Temps Restant</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #10b981; margin-top: 3px;">‚è±Ô∏è ${timeRemaining}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Validit√©</div>
                                    <div style="font-size: 13px; color: #065f46; margin-top: 3px;">
                                        De: ${visitor.startTime.toLocaleString('fr-FR')}<br>
                                        √Ä: ${visitor.endTime.toLocaleString('fr-FR')}
                                    </div>
                                </div>
                                ${visitor.mariage ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #d1fae5;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600; margin-bottom: 12px;">üìç D√©tails du Mariage</div>
                                    <div style="background: #f0fdf4; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                        <div style="font-size: 13px; color: #065f46;"><strong>‚õ™ √âglise:</strong> ${visitor.mariage.eglise || 'N/A'}</div>
                                        ${visitor.mariage.egliseAdresse ? `<div style="font-size: 12px; color: #099268; margin-top: 4px;">üìÆ ${visitor.mariage.egliseAdresse}</div>` : ''}
                                    </div>
                                    <div style="background: #f0fdf4; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                        <div style="font-size: 13px; color: #065f46;"><strong>üèòÔ∏è Commune:</strong> ${visitor.mariage.commune || 'N/A'}</div>
                                    </div>
                                    <div style="background: #f0fdf4; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                        <div style="font-size: 13px; color: #065f46;"><strong>üì∏ Photographe:</strong> ${visitor.mariage.photographe || 'N/A'}</div>
                                    </div>
                                    ${visitor.mariage.evenements && visitor.mariage.evenements.length > 0 ? `
                                    <div style="background: #f0fdf4; border-radius: 6px; padding: 12px;">
                                        <div style="font-size: 13px; color: #065f46; font-weight: 600; margin-bottom: 8px;">‚è∞ Chronologie des √âv√©nements:</div>
                                        ${visitor.mariage.evenements.map(e => `
                                            <div style="font-size: 12px; color: #065f46; margin: 6px 0; padding-left: 10px;">
                                                <strong>${e.time || '--:--'}</strong> - ${e.description || '√âv√©nement'}
                                            </div>
                                        `).join('')}
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 12px; border-radius: 4px; font-size: 13px; color: #15803d; font-weight: 600;">
                            ‚úì C√©r√©monie valid√©e - Acc√®s Autoris√©
                        </div>
                    </div>
                `;
            } else if (!isValid && isCer) {
                let reason = 'C√©r√©monie non valide';
                let reasonDetails = '';
                if (isComing) {
                    reason = 'Pas Encore Valide';
                    reasonDetails = `Valide √† partir de ${visitor.startTime.toLocaleString('fr-FR')}`;
                } else if (isExpired) {
                    const timeLeft = visitor.endTime - new Date();
                    const minutesExpired = Math.floor(-timeLeft / 60000);
                    const hoursExpired = Math.floor(minutesExpired / 60);
                    reason = 'C√©r√©monie Expir√©e';
                    reasonDetails = `Expir√©e il y a ${hoursExpired > 0 ? hoursExpired + 'h ' : ''}${minutesExpired % 60}m`;
                }
                
                const familiesDisplay = visitor.families && visitor.families.length > 0 
                    ? visitor.families.join(' & ')
                    : 'N/A';
                
                return `
                    <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 3px solid #ef4444; border-radius: 12px; padding: 25px; animation: slideInRight 0.3s ease-out;">
                        <div style="font-size: 64px; margin-bottom: 15px; text-align: center;">‚úó</div>
                        <div style="font-weight: 700; color: #ef4444; margin-bottom: 20px; text-align: center; font-size: 20px;">Acc√®s Refus√©</div>
                        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);">
                            <div style="display: grid; gap: 12px;">
                                <div style="text-align:center;">${photoDisplay}</div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Nom de la C√©r√©monie</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #7f1d1d; margin-top: 5px;">${visitor.name}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Raison du Refus</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #dc2626; margin-top: 3px;">‚ö†Ô∏è ${reason}</div>
                                    <div style="font-size: 13px; color: #7f1d1d; margin-top: 5px;">${reasonDetails}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Type</div>
                                    <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">üéâ ${visitor.type}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Famille(s)</div>
                                    <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">üë• ${familiesDisplay}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Lieu</div>
                                    <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">üìç ${visitor.location}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Place Attitr√©e</div>
                                    <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">üìå ${visitor.place || 'N/A'}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Nombre de personnes</div>
                                    <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">üë• ${visitor.capacity || 1}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Sexe</div>
                                    <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">‚öß ${visitor.sexe || 'N/A'}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">T√©l√©phone</div>
                                    <div style="font-size: 13px; color: #7f1d1d; margin-top: 3px;">üì± ${visitor.phone || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">P√©riode</div>
                                    <div style="font-size: 13px; color: #7f1d1d; margin-top: 3px;">
                                        De: ${visitor.startTime.toLocaleString('fr-FR')}<br>
                                        √Ä: ${visitor.endTime.toLocaleString('fr-FR')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 4px; font-size: 13px; color: #991b1b; font-weight: 600;">
                            ‚úó Acc√®s non autoris√© - Merci de contacter l'administrateur
                        </div>
                    </div>
                `;
            }
            
            // Retourner null pour les visiteurs non c√©r√©monies, la fonction d'affichage g√©rera les cas g√©n√©riques
                return null;
            }

            // === Fonctions pour scanner le QR depuis la cam√©ra dans l'onglet V√©rifier ===
            let verifyStream = null;
            let verifyScanActive = false;
            let verifyScanAnimationId = null;

            function toggleVerifyScanner() {
                const scanner = document.getElementById('verifyScanner');
                if (!scanner) return;
                if (scanner.style.display === 'none' || scanner.style.display === '') {
                    startVerifyCamera();
                } else {
                    stopVerifyCamera();
                }
            }

            function startVerifyCamera() {
                const video = document.getElementById('verifyVideo');
                const status = document.getElementById('verifyCameraStatus');
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    if (status) { status.textContent = 'Navigateur ne supporte pas getUserMedia'; status.style.color = '#ef4444'; }
                    return;
                }

                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
                    .then(stream => {
                        verifyStream = stream;
                        video.srcObject = stream;
                        document.getElementById('verifyScanner').style.display = 'block';
                        document.getElementById('startScanBtn').textContent = '‚úñÔ∏è';
                        if (status) { status.textContent = 'Cam√©ra active - recherche du QR...'; status.style.color = '#10b981'; }
                        verifyScanActive = true;
                        scanVerifyFrame();
                    })
                    .catch(err => {
                        console.error('Erreur cam√©ra verify:', err);
                        if (status) { status.textContent = '‚ùå Erreur: acc√®s cam√©ra refus√©.'; status.style.color = '#ef4444'; }
                    });
            }

            function stopVerifyCamera() {
                verifyScanActive = false;
                if (verifyStream) {
                    verifyStream.getTracks().forEach(t => t.stop());
                    verifyStream = null;
                }
                const video = document.getElementById('verifyVideo');
                if (video) video.srcObject = null;
                const scanner = document.getElementById('verifyScanner');
                if (scanner) scanner.style.display = 'none';
                if (document.getElementById('startScanBtn')) document.getElementById('startScanBtn').textContent = 'üì∑';
                if (verifyScanAnimationId) cancelAnimationFrame(verifyScanAnimationId);
                const status = document.getElementById('verifyCameraStatus');
                if (status) { status.textContent = 'Cam√©ra arr√™t√©e'; status.style.color = '#6b7280'; }
            }

            function scanVerifyFrame() {
                const video = document.getElementById('verifyVideo');
                const canvas = document.getElementById('verifyCanvas');
                if (!verifyScanActive) return;
                if (!video || !canvas) return;

                if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                    verifyScanAnimationId = requestAnimationFrame(scanVerifyFrame);
                    return;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                try {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
                    if (code && code.data) {
                        document.getElementById('verifyCode').value = code.data;
                        stopVerifyCamera();
                        const status = document.getElementById('verifyCameraStatus');
                        if (status) { status.textContent = 'QR d√©tect√©'; status.style.color = '#10b981'; }
                        setTimeout(() => { verifyCode(); }, 200);
                        return;
                    }
                } catch (e) {
                    console.error('Erreur lecture imageData:', e);
                }

                verifyScanAnimationId = requestAnimationFrame(scanVerifyFrame);
            }

            function verifyCode() {
            const code = document.getElementById('verifyCode').value.trim();
            if (!code) return;

            // Rechercher d'abord par ID, puis par code rapide si aucun r√©sultat et que le code a une longueur de 5 caract√®res
            let visitor = visitors.find(v => v.id === code);
            if (!visitor && code.length === 5) {
                visitor = visitors.find(v => v.quickCode === code);
            }
            
            const resultDiv = document.getElementById('verifyResult');
            const contentDiv = document.getElementById('verifyContent');

            if (!visitor) {
                resultDiv.style.display = 'block';
                contentDiv.innerHTML = `
                    <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úó</div>
                        <div style="font-weight: 600; color: #ef4444; margin-bottom: 5px;">Code Non Trouv√©</div>
                        <p style="color: #991b1b; font-size: 14px;">Aucune invitation ne correspond √† ce code</p>
                    </div>
                `;;
                document.getElementById('verifyCode').value = '';
                return;
            }

            const now = new Date();
            const isValid = now >= visitor.startTime && now <= visitor.endTime;
            const isComing = now < visitor.startTime;
            const isExpired = now > visitor.endTime;
            const isDuplicate = visitor.category === 'ceremonie' && visitor.scans && visitor.scans.length > 0;

            // Declanchement de l'alarme de duplication si necessaire
            if (isDuplicate) {
                showAlarm('Duplication D√©tect√©e', 'Ce code QR a d√©j√† √©t√© scann√©!', 'warning');
            }

            visitor.scans.push({ timestamp: now, result: isValid ? 'approved' : 'denied', isDuplicate: isDuplicate });
            localStorage.setItem('visitors', JSON.stringify(visitors));

            accessLog.push({
                visitorId: visitor.id,
                visitorName: visitor.name,
                timestamp: now,
                result: isValid ? 'approved' : 'denied',
                location: visitor.location
            });
            localStorage.setItem('accessLog', JSON.stringify(accessLog));

            resultDiv.style.display = 'block';
            
            // Calculer le temps restant pour les visiteurs valides ou le temps √©coul√© pour les c√©r√©monies expir√©es
            const timeLeft = visitor.endTime - now;
            const minutesLeft = Math.floor(timeLeft / 60000);
            const hoursLeft = Math.floor(minutesLeft / 60);
            const timeRemaining = hoursLeft > 0 ? `${hoursLeft}h ${minutesLeft % 60}m` : `${minutesLeft}m`;
            
            const photoDisplay = visitor.photo
                ? `<img id="verifyPhoto" src="${visitor.photo}" alt="Photo" style="width: 150px; height: 150px; border-radius: 10px; margin: 15px 0; object-fit: cover; border: 3px solid #10b981;">`
                : '<div style="width: 150px; height: 150px; background: #e5e7eb; border-radius: 10px; margin: 15px auto; display: flex; align-items: center; justify-content: center; color: #6b7280;">Pas de photo</div>';

            // Afficher un message de duplication pour les c√©r√©monies d√©j√† scann√©es, sinon afficher les d√©tails de validation ou de refus
            if (isDuplicate) {
                contentDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fef08a 0%, #fde047 100%); border: 3px solid #f59e0b; border-radius: 12px; padding: 25px; animation: slideInRight 0.3s ease-out;">
                        <div style="font-size: 64px; margin-bottom: 15px; text-align: center;">‚ö†Ô∏è</div>
                        <div style="font-weight: 700; color: #f59e0b; margin-bottom: 20px; text-align: center; font-size: 24px;">Duplic</div>
                        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.1);">
                            <div style="display: grid; gap: 12px;">
                                <div style="border-bottom: 2px solid #fffbeb; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #f59e0b; font-weight: 600;">Nom</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #92400e; margin-top: 5px;">${visitor.name}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fffbeb; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #f59e0b; font-weight: 600;">Statut</div>
                                    <div style="font-size: 14px; color: #92400e; margin-top: 3px;">üîÑ Code QR d√©j√† scann√©</div>
                                </div>
                                <div style="border-bottom: 2px solid #fffbeb; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #f59e0b; font-weight: 600;">Lieu d'Acc√®s</div>
                                    <div style="font-size: 14px; color: #92400e; margin-top: 3px;">üìç ${visitor.location}</div>
                                </div>
                                <div style="border-bottom: 2px solid #fffbeb; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #f59e0b; font-weight: 600;">Total Scans</div>
                                    <div style="font-size: 14px; color: #92400e; margin-top: 3px;">üîç ${visitor.scans.length} scan(s)</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px; font-size: 13px; color: #92400e; font-weight: 600; text-align: center;">
                            ‚ö†Ô∏è Attention: Ce code QR a d√©j√† √©t√© scann√© auparavant!
                        </div>
                    </div>
                `;
            } else if (isValid) {
                // Verifier si c'est une c√©r√©monie et g√©n√©rer l'affichage sp√©cifique, sinon afficher les d√©tails g√©n√©riques du visiteur
                const ceremonyDisplay = generateVerificationDisplay(visitor, true, timeRemaining, isExpired, isComing, photoDisplay);
                if (ceremonyDisplay) {
                    contentDiv.innerHTML = ceremonyDisplay;
                } else {
                    // Defaut pour les visiteurs non c√©r√©monies
                    contentDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%); border: 3px solid #10b981; border-radius: 12px; padding: 25px; animation: slideInRight 0.3s ease-out;">
                        <div style="font-size: 64px; margin-bottom: 15px; text-align: center;">‚úì</div>
                        <div style="font-weight: 700; color: #10b981; margin-bottom: 20px; text-align: center; font-size: 20px;">Acc√®s Autoris√©</div>
                        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);">
                            <div style="text-align: center;">
                                ${photoDisplay}
                            </div>
                            <div style="display: grid; gap: 12px;">
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Nom du Rendez-vous</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #065f46; margin-top: 5px;">${visitor.name}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Type de Rendez-vous</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üìã ${visitor.type}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Sexe</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">‚öß ${visitor.sexe || 'N/A'}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Lieu d'Acc√®s</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üìç ${visitor.location}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Num√©ro de Demande</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">#Ô∏è‚É£ ${visitor.requestNumber}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Service</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üõ†Ô∏è ${visitor.service}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Temps Restant</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #10b981; margin-top: 3px;">‚è±Ô∏è ${timeRemaining}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Email</div>
                                    <div style="font-size: 13px; color: #065f46; margin-top: 3px;">üìß ${visitor.email}</div>
                                </div>
                                <div style="border-bottom: 2px solid #f0fdf4; padding-bottom: 12px;">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Validit√©</div>
                                    <div style="font-size: 13px; color: #065f46; margin-top: 3px;">
                                        De: ${visitor.startTime.toLocaleString('fr-FR')}<br>
                                        √Ä: ${visitor.endTime.toLocaleString('fr-FR')}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #10b981; font-weight: 600;">Total Scans</div>
                                    <div style="font-size: 14px; color: #065f46; margin-top: 3px;">üîç ${visitor.scans.length} scan(s)</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 12px; border-radius: 4px; font-size: 13px; color: #15803d; font-weight: 600;">
                            ‚úì Invitation valide et active - Acc√®s Autoris√©
                        </div>
                    </div>
                `;
                }
                playSound('success');
            } else {
                // Verifier si c'est une c√©r√©monie et g√©n√©rer l'affichage sp√©cifique pour les c√©r√©monies invalides, sinon afficher les d√©tails g√©n√©riques du refus
                const ceremonyDisplay = generateVerificationDisplay(visitor, false, timeRemaining, isExpired, isComing, photoDisplay);
                if (ceremonyDisplay) {
                    contentDiv.innerHTML = ceremonyDisplay;
                } else {
                    // Defaut pour les visiteurs non c√©r√©monies
                    let reason = 'Invitation non valide';
                    let reasonDetails = '';
                    
                    if (isComing) {
                        reason = 'Pas Encore Valide';
                        reasonDetails = `Valide √† partir de ${visitor.startTime.toLocaleString('fr-FR')}`;
                    } else if (isExpired) {
                        const minutesExpired = Math.floor(-timeLeft / 60000);
                        const hoursExpired = Math.floor(minutesExpired / 60);
                        reason = 'Invitation Expir√©e';
                        reasonDetails = `Expir√© il y a ${hoursExpired > 0 ? hoursExpired + 'h ' : ''}${minutesExpired % 60}m`;
                    }
                    
                    contentDiv.innerHTML = `
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 3px solid #ef4444; border-radius: 12px; padding: 25px; animation: slideInRight 0.3s ease-out;">
                            <div style="font-size: 64px; margin-bottom: 15px; text-align: center;">‚úó</div>
                            <div style="font-weight: 700; color: #ef4444; margin-bottom: 20px; text-align: center; font-size: 20px;">Acc√®s Refus√©</div>
                            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);">
                                <div style="text-align: center;">
                                    ${photoDisplay}
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Nom du Rendez-vous</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #7f1d1d; margin-top: 5px;">${visitor.name}</div>
                                    </div>
                                    <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Sexe</div>
                                        <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">‚öß ${visitor.sexe || 'N/A'}</div>
                                    </div>
                                    <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Raison du Refus</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #dc2626; margin-top: 3px;">‚ö†Ô∏è ${reason}</div>
                                        <div style="font-size: 13px; color: #7f1d1d; margin-top: 5px;">${reasonDetails}</div>
                                    </div>
                                    <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Lieu</div>
                                        <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">üìç ${visitor.location}</div>
                                    </div>
                                    <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Num√©ro de Demande</div>
                                        <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">#Ô∏è‚É£ ${visitor.requestNumber}</div>
                                    </div>
                                    <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Service</div>
                                        <div style="font-size: 14px; color: #7f1d1d; margin-top: 3px;">üõ†Ô∏è ${visitor.service}</div>
                                    </div>
                                    <div style="border-bottom: 2px solid #fee2e2; padding-bottom: 12px;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">Email</div>
                                        <div style="font-size: 13px; color: #7f1d1d; margin-top: 3px;">üìß ${visitor.email}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #dc2626; font-weight: 600;">P√©riode Valide</div>
                                        <div style="font-size: 13px; color: #7f1d1d; margin-top: 3px;">
                                            De: ${visitor.startTime.toLocaleString('fr-FR')}<br>
                                            √Ä: ${visitor.endTime.toLocaleString('fr-FR')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 4px; font-size: 13px; color: #991b1b; font-weight: 600;">
                                ‚úó Acc√®s non autoris√© - Merci de contacter l'administrateur
                            </div>
                        </div>
                    `;
                }
                playSound('denied');
            }

            // Assurer que la photo de v√©rification est mise √† jour si disponible
            const verifyImgEl = document.getElementById('verifyPhoto');
            if (verifyImgEl && visitor.photo) {
                verifyImgEl.src = visitor.photo;
            }

            // Effacement automatique du r√©sultat apr√®s 3 secondes pour pr√©parer la prochaine v√©rification
            setTimeout(() => {
                document.getElementById('verifyCode').value = '';
                document.getElementById('verifyCode').focus();
            }, 3000);

            updateDashboard();
        }

        // Actualiser le tableau de bord
        function updateDashboard() {
            const now = new Date();
            let activeCount = 0;
            let expiringCount = 0;
            const oneHourLater = new Date(now.getTime() + 60 * 60000);

            const activeHtml = [];
            const expiringHtml = [];

            visitors.forEach(v => {
                if (now >= v.startTime && now <= v.endTime) {
                    activeCount++;
                    activeHtml.push(createVisitorHTML(v, false));
                }

                if (now <= v.endTime && v.endTime <= oneHourLater) {
                    expiringCount++;
                    expiringHtml.push(createVisitorHTML(v, true));
                }
            });

            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('totalCount').textContent = visitors.length;
            document.getElementById('expiringCount').textContent = expiringCount;
            document.getElementById('accessCount').textContent = accessLog.filter(l => {
                const logDate = new Date(l.timestamp);
                const today = new Date();
                return logDate.toDateString() === today.toDateString();
            }).length;

            document.getElementById('visitorsActive').innerHTML = activeHtml.length ? activeHtml.join('') : '<p style="text-align: center; color: var(--dark); opacity: 0.5;">Aucun rendez-vous actif</p>';
            document.getElementById('visitorsExpiring').innerHTML = expiringHtml.length ? expiringHtml.join('') : '<p style="text-align: center; color: var(--dark); opacity: 0.5;">Aucune expiration proche</p>';
        }

        // Creer le HTML pour un visiteur dans les listes Actifs et Expirants
        function createVisitorHTML(visitor, isExpiring) {
            const now = new Date();
            const isExpired = now > visitor.endTime;
            const isComing = now < visitor.startTime;

            let statusText = 'Actif';
            let statusClass = 'active';

            if (isExpired) {
                statusText = 'Expir√©';
                statusClass = 'expired';
            } else if (isExpiring) {
                statusText = 'Expire Bient√¥t';
                statusClass = 'expiring';
            } else if (isComing) {
                statusText = '√Ä Venir';
                statusClass = 'expiring';
            }

            const photoHtml = visitor.photo 
                ? `<div class="visitor-photo"><img src="${visitor.photo}" alt="${visitor.name}"></div>`
                : `<div class="visitor-photo">üë§</div>`;

            return `
                <div class="visitor-item ${statusClass}" onclick="showVisitorDetails('${visitor.id}')">
                    ${photoHtml}
                    <div class="visitor-info">
                        <div class="visitor-name">${visitor.name}</div>
                        <div class="visitor-meta">
                            <span>üìç ${visitor.location}</span>
                            <span>üõ†Ô∏è ${visitor.service}</span>
                            <span>#Ô∏è‚É£ ${visitor.requestNumber}</span>
                            <span>‚öß ${visitor.sexe || 'N/A'}</span>
                            <span>‚è±Ô∏è ${visitor.endTime.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</span>
                            <span>üìß ${visitor.email}</span>
                        </div>
                    </div>
                    <div class="visitor-status ${statusClass}">
                        <div class="status-dot"></div>
                        ${statusText}
                    </div>
                </div>
            `;
        }

        // Les details du visiteur
        function showVisitorDetails(visitorId) {
            const visitor = visitors.find(v => v.id === visitorId);
            if (!visitor) return;

            alert(`
Rendez-vous: ${visitor.name}
Email: ${visitor.email}
T√©l√©phone: ${visitor.phone}
Num√©ro de Demande: ${visitor.requestNumber}
Service: ${visitor.service}
Type: ${visitor.type}
Lieu: ${visitor.location}
Place Attitr√©e: ${visitor.place || 'N/A'}
D√©but: ${visitor.startTime.toLocaleString('fr-FR')}
Fin: ${visitor.endTime.toLocaleString('fr-FR')}
Nombre de personnes: ${visitor.capacity || 1}
Scans: ${visitor.scans.length}
Photo: ${visitor.photo ? 'Oui' : 'Non'}
Sexe: ${visitor.sexe || 'N/A'}
            `);
        }

        // Mise a jour du journal d'acc√®s
        function updateAccessLog() {
            const logHtml = accessLog.slice(-50).reverse().map(log => {
                const date = new Date(log.timestamp);
                const icon = log.result === 'approved' ? '‚úì' : '‚úó';
                const statusClass = log.result === 'approved' ? '' : 'denied';
                
                return `
                    <div class="log-item ${statusClass}">
                        <div class="log-timestamp">${icon} ${date.toLocaleString('fr-FR')}</div>
                        <div class="log-details">
                            <strong>${log.visitorName}</strong> - ${log.location}
                            ${log.result === 'approved' ? '(Acc√®s Autoris√©)' : '(Acc√®s Refus√©)'}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('accessLog').innerHTML = logHtml || '<p style="text-align: center; color: var(--dark); opacity: 0.5;">Aucun acc√®s enregistr√©</p>';
        }

        // --- Historique de recherche (Ceuc dont leurs code qr on ete enreg.) ---
        function debounce(fn, wait) {
            let t;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        function renderHistorySearchResults(results) {
            const container = document.getElementById('historyResults');
            if (!container) return;
            if (!results || results.length === 0) {
                container.innerHTML = '<p style="text-align: left; color: var(--dark); opacity: 0.6;">Aucun r√©sultat</p>';
                return;
            }

            container.innerHTML = results.map(v => {
                const photoHtml = v.photo ? `<div class="visitor-photo"><img src="${v.photo}" alt="${v.name}"></div>` : `<div class="visitor-photo">üë§</div>`;
                const endTimeStr = v.endTime ? (new Date(v.endTime)).toLocaleString('fr-FR') : '';
                return `
                    <div class="visitor-item" style="cursor:pointer;" onclick="showVisitorDetails('${v.id}')">
                        ${photoHtml}
                        <div class="visitor-info">
                            <div class="visitor-name">${v.name}</div>
                            <div class="visitor-meta">
                                <span>üî¢ ${v.quickCode || v.id}</span>
                                <span>üìç ${v.location || 'N/A'}</span>
                                <span>üì± ${v.phone || 'N/A'}</span>
                                <span>‚è±Ô∏è ${endTimeStr}</span>
                            </div>
                        </div>
                        <div class="visitor-status active">
                            <div class="status-dot"></div>
                            D√©tails
                        </div>
                    </div>
                `;
            }).join('');
        }

        function performHistorySearch() {
            const q = document.getElementById('historySearch').value.trim().toLowerCase();
            if (!q) {
                document.getElementById('historyResults').innerHTML = '';
                return;
            }

            const results = visitors.filter(v => {
                return (v.name && v.name.toLowerCase().includes(q)) ||
                       (v.quickCode && v.quickCode.toLowerCase().includes(q)) ||
                       (v.id && v.id.toLowerCase().includes(q)) ||
                       (v.phone && v.phone.toLowerCase().includes(q)) ||
                       (v.email && v.email.toLowerCase().includes(q));
            });

            renderHistorySearchResults(results);
        }

        const historySearchDebounced = debounce(performHistorySearch, 200);

        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('historySearch');
            const clearBtn = document.getElementById('historyClearBtn');
            if (searchInput) searchInput.addEventListener('input', historySearchDebounced);
            if (clearBtn) clearBtn.addEventListener('click', function() {
                if (searchInput) searchInput.value = '';
                document.getElementById('historyResults').innerHTML = '';
                searchInput && searchInput.focus();
            });
        });

        // Systhene d'alarme pour les invitations expir√©es et celles qui expirent bient√¥t
        function startAlarmSystem() {
            setInterval(function() {
                const now = new Date();
                const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);

                visitors.forEach(visitor => {
                    // Verifier les invitations expir√©es (dans la derni√®re minute)
                    if (now > visitor.endTime && visitor.endTime > new Date(now.getTime() - 1 * 60000)) {
                        showAlarm(`${visitor.name} - Invitation Expir√©e!`, `L'invitation de ${visitor.name} pour ${visitor.location} a expir√©.`);
                    }

                    // Verifier les invitations qui expirent dans les 5 prochaines minutes
                    if (visitor.endTime <= fiveMinutesLater && visitor.endTime > now) {
                        const minutesLeft = Math.round((visitor.endTime - now) / 60000);
                        showAlarm(`${visitor.name} - Expire Bient√¥t!`, `L'invitation expire dans ${minutesLeft} minutes.`, 'warning');
                    }
                });
            }, 30000); // Verifier toutes les 30 secondes
        }

        // Afficher l'alarme
        function showAlarm(title, message, type = 'danger') {
            const notification = document.getElementById('alarmNotification');
            const details = document.getElementById('alarmDetails');

            details.textContent = message;
            notification.classList.add('active');

            if (type === 'danger') {
                notification.classList.add('alarm-active');
            } else {
                notification.classList.remove('alarm-active');
            }

            playSound('alarm');

            setTimeout(function() {
                closeAlarm();
            }, 8000);
        }

        // Fermer l'alarme
        function closeAlarm() {
            const notification = document.getElementById('alarmNotification');
            notification.classList.remove('active');
            notification.classList.remove('alarm-active');
        }

        // Jouer un son pour les diff√©rentes actions (succ√®s, refus, alarme)
        function playSound(type) {
            // Utiliser l'API Web Audio pour g√©n√©rer des sons simples sans d√©pendre de fichiers externes
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = type === 'success' ? 800 : type === 'denied' ? 400 : 600;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Rapport Journalier
        function showDailyReport() {
            const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
            const dailyVisitors = visitors.filter(v => v.date === today);
            const dailyAccessLog = accessLog.filter(log => log.date === today);

            document.getElementById('reportContent').innerHTML = '<div class="report-section"><div class="report-title">üìä Bilan Journalier</div><div class="report-stats"><div class="report-stat"><div class="report-stat-value">' + dailyVisitors.length + '</div><div class="report-stat-label">Invitations Totales</div></div><div class="report-stat"><div class="report-stat-value">' + dailyVisitors.filter(v => new Date() >= v.startTime && new Date() <= v.endTime).length + '</div><div class="report-stat-label">Actives</div></div><div class="report-stat"><div class="report-stat-value">' + dailyVisitors.filter(v => new Date() > v.endTime).length + '</div><div class="report-stat-label">Expir√©es</div></div><div class="report-stat"><div class="report-stat-value">' + dailyAccessLog.length + '</div><div class="report-stat-label">Scans Total</div></div></div></div>';
            document.getElementById('reportModal').classList.add('active');
        }

        function downloadReport() {
            let csv = 'BILAN JOURNALIER\nTotal,' + visitors.length + '\nActifs,' + visitors.filter(v => new Date() >= v.startTime && new Date() <= v.endTime).length;
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'bilan.csv';
            link.click();
            alert('‚úì T√©l√©charg√©!');
        }

        function resetInvitations() {
            document.getElementById('resetModal').classList.add('active');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('active');
        }

        function confirmResetInvitations() {
            visitors = [];
            accessLog = [];
            localStorage.setItem('visitors', JSON.stringify(visitors));
            localStorage.setItem('accessLog', JSON.stringify(accessLog));
            closeResetModal();
            updateDashboard();
            alert('‚úì R√©initialis√©!');
        }
    </script>
</body>
</html>
